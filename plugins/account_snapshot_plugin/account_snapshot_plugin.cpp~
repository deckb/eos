/**
 *  @file
 *  @copyright defined in eos/LICENSE.txt
 */
#include <eosio/account_snapshot_plugin/account_snapshot_plugin.hpp>
#include <string>
#include <fc/io/json.hpp>

#include <eosio/chain/controller.hpp>
#include <eosio/chain/trace.hpp>
#include <eosio/chain_plugin/chain_plugin.hpp>

namespace eosio {
  using namespace chain;
  using boost::signals2::scoped_connection;

  static appbase::abstract_plugin& _account_snapshot_plugin = app().register_plugin<account_snapshot_plugin>();

  class account_snapshot_plugin_impl {
  public:
    chain_plugin*          chain_plug = nullptr;

    static const int64_t DEFAULT_TRANSACTION_TIME_LIMIT;
    int64_t transactions_time_limit = DEFAULT_TRANSACTION_TIME_LIMIT;
    
    fc::microseconds       abi_serializer_max_time;

    fc::optional<scoped_connection> applied_transaction_connection;
    
    account_snapshot_plugin_impl()
    {
    }

    void on_applied_transaction( const transaction_trace_ptr& trace )
    {
      for( const auto& atrace : trace->action_traces )
	{
	  on_action_trace( atrace );
	}
    }

    void on_action_trace( const action_trace& at )
    {
      if (at.act.name == NEW_ACCOUNT) {
	const auto create = at.act.data_as<chain::newaccount>();
	ilog("Created ${u}", ("u",create.name));
      }
    }

  private:
    const account_name NEW_ACCOUNT = "newaccount";
  };


  account_snapshot_plugin::account_snapshot_plugin():my(new account_snapshot_plugin_impl()){}
  account_snapshot_plugin::~account_snapshot_plugin(){}

  void account_snapshot_plugin::set_program_options(options_description&, options_description& cfg)
  {
    cfg.add_options()
      ("account_snapshot_file,f", bpo::value<vector<string>>()->composing(),
       "File to append account creation.")
      ;
  }

  void account_snapshot_plugin::plugin_initialize(const variables_map& options)
  {
    
    my->chain_plug = app().find_plugin<chain_plugin>();
    my->abi_serializer_max_time = my->chain_plug->get_abi_serializer_max_time();

    auto& chain = my->chain_plug->chain();

    my->applied_transaction_connection.emplace(chain.applied_transaction.connect( [&]( const transaction_trace_ptr& p ){
	  my->on_applied_transaction(p);
	}));
  }

  void account_snapshot_plugin::plugin_startup() {

  }

  void account_snapshot_plugin::plugin_shutdown() {
  }

}

